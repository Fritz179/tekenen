<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8" />
        <title>Example on WASM</title>
    </head>
    <body>

        <style>
            html {
                background-color: #515151;
            }
        </style>

        <canvas id="canvas"></canvas>
        <script type="module">
            const canvas = document.querySelector('#canvas')
            const ctx = canvas.getContext('2d')


            import init, { wasm_start, wasm_run_callback, wasm_key_down, wasm_mouse_down, wasm_mouse_move, wasm_mouse_up } from "./wasm/example.js";
            
            window.js_set_size = (width, height) => {
                console.log(width, height)
                canvas.width = width
                canvas.height = height
            }

            window.js_display_pixels = pixels => {
                const clamped = new Uint8ClampedArray(pixels)
                const data = new ImageData(clamped, canvas.width)
                ctx.putImageData(data, 0, 0)
            }

            window.js_set_interval = fps => {
                window.setInterval(() => {
                    wasm_run_callback()
                }, 1000 / fps)
            }

            window.js_log = (msg) => {
                console.log(msg);
            }

            window.addEventListener('keydown', e => {
                if (e.key.length == 1) {
                    wasm_key_down(e.key)
                    return
                }

                if (e.key == 'Enter') {
                    wasm_key_down('\n')
                    return
                }
            })

            canvas.addEventListener('mousedown', e => {
                wasm_mouse_down(e.offsetX, e.offsetY)
            })

            canvas.addEventListener('mousemove', e => {
                console.log(e)
                wasm_mouse_move(e.offsetX, e.offsetY, e.movementX, e.movementY)
            })

            canvas.addEventListener('mouseup', e => {
                wasm_mouse_up(e.offsetX, e.offsetY)
            })

            init().then(() => {
                console.log("wasm_start");
                wasm_start();
                console.log("wasm_start done");
            });
        </script>
    </body>
</html>